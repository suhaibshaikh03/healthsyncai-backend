name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # Build and Push Docker Image
      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:latest .
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:latest

      # Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Deploy to Azure Container Apps
      - name: Deploy to Azure Container Apps
        run: |
          az containerapp create \
            --name mycontainerapp \
            --resource-group myresourcegroup \
            --environment mycontainerappenv \
            --image ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:latest \
            --target-port 3000 \
            --ingress external \
            --query properties.configuration.ingress.fqdn \
            --env-vars \
              PORT=${{ secrets.PORT }} \
              MONGO_URL='${{ secrets.MONGO_URL }}' \
              JWT_SECRET=${{ secrets.JWT_SECRET }} \
              SECRET_KEY=${{ secrets.SECRET_KEY }} \
              HASH_PASS=${{ secrets.HASH_PASS }} \
              CLIENT_URL=${{ secrets.CLIENT_URL }} \
              GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
              CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
              CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
              CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
          || \
          az containerapp update \
            --name mycontainerapp \
            --resource-group myresourcegroup \
            --image ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:latest \
            --set-env-vars \
              PORT=${{ secrets.PORT }} \
              MONGO_URL='${{ secrets.MONGO_URL }}' \
              JWT_SECRET=${{ secrets.JWT_SECRET }} \
              SECRET_KEY=${{ secrets.SECRET_KEY }} \
              HASH_PASS=${{ secrets.HASH_PASS }} \
              CLIENT_URL=${{ secrets.CLIENT_URL }} \
              GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
              CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
              CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
              CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
